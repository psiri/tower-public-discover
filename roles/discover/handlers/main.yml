#REQUIRES ANSIBLE 2.3
- name: ARCHIVE PLAY OUTPUT
  archive:
    path: "{{ backup_dir }}{{ ansible_date_time.get('date') }}_{{ ansible_date_time.get('hour') }}-{{ ansible_date_time.get('minute') }}"
    dest: "{{ backup_dir }}{{ ansible_date_time.get('date') }}_{{ ansible_date_time.get('hour') }}-{{ ansible_date_time.get('minute') }}.zip"
    format: zip
    remove: no
  run_once: true
  changed_when: False
  delegate_to: localhost
  delegate_facts: True


#ARCHIVE EMAIL REQUIRES ANSIBLE 2.3
- name: SEND CONFIRMATION EMAIL
  mail:
    host: smtp.office365.com
    port: 587
    body: "Backup, Discovery, and Reporting Complete! \n\n\n --- Automatically Generated by Ansible ---"
    from: "{{ email_username }}"
    to: "{{ email_destination }}"
    attach: "{{ backup_dir }}{{ ansible_date_time.get('date') }}_{{ ansible_date_time.get('hour') }}-{{ ansible_date_time.get('minute') }}.zip"
    username: "{{ email_username }}"
    password: "{{ email_password }}"
    subject: "Ansible Backup, Discovery, and Reporting"
  run_once: true
  delegate_to: localhost
  delegate_facts: True